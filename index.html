<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raycasting Engine</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: monospace;
      }
      #game {
        border: 2px solid #333;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #0f0;
        font-size: 14px;
        text-shadow: 2px 2px 4px #000;
      }
    </style>
  </head>
  <body>
    <canvas id="game"></canvas>
    <div id="info">
      Use WASD or Arrow Keys to move<br />
      Mouse to look around<br />
      Click to lock pointer
    </div>

    <script>
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      canvas.width = 800;
      canvas.height = 600;

      // Map (1 = wall, 0 = empty)
      const map = [
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1],
        [1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
        [1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
        [1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
        [1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      ];

      // Player
      const player = {
        x: 2.5,
        y: 2.5,
        angle: 0,
        fov: Math.PI / 3,
        speed: 0.05,
        rotSpeed: 0.003,
      };

      // Input
      const keys = {};
      let mouseX = 0;

      document.addEventListener(
        "keydown",
        (e) => (keys[e.key.toLowerCase()] = true)
      );
      document.addEventListener(
        "keyup",
        (e) => (keys[e.key.toLowerCase()] = false)
      );

      canvas.addEventListener("click", () => {
        canvas.requestPointerLock();
      });

      document.addEventListener("mousemove", (e) => {
        if (document.pointerLockElement === canvas) {
          mouseX = e.movementX;
        }
      });

      // Wall colors
      const wallColors = ["#8B4513", "#A0522D", "#654321", "#D2691E"];

      function castRay(angle) {
        const sin = Math.sin(angle);
        const cos = Math.cos(angle);

        let t = 0;
        const step = 0.01;

        while (t < 20) {
          const x = player.x + cos * t;
          const y = player.y + sin * t;

          const mapX = Math.floor(x);
          const mapY = Math.floor(y);

          if (
            mapY >= 0 &&
            mapY < map.length &&
            mapX >= 0 &&
            mapX < map[0].length &&
            map[mapY][mapX] === 1
          ) {
            // Determine wall type based on hit position
            const wallType = (mapX + mapY) % 4;
            const side =
              Math.abs(x - mapX - 0.5) > Math.abs(y - mapY - 0.5)
                ? "vertical"
                : "horizontal";

            return { dist: t, wallType, side };
          }
          t += step;
        }
        return { dist: 20, wallType: 0, side: "vertical" };
      }

      function drawWall(x, height, wallType, side) {
        const color = wallColors[wallType];
        const darken = side === "horizontal" ? 0.7 : 1;

        // Parse RGB from hex
        const r = parseInt(color.slice(1, 3), 16) * darken;
        const g = parseInt(color.slice(3, 5), 16) * darken;
        const b = parseInt(color.slice(5, 7), 16) * darken;

        ctx.fillStyle = `rgb(${r},${g},${b})`;
        ctx.fillRect(x, (canvas.height - height) / 2, 1, height);
      }

      function render() {
        // Clear with floor and ceiling
        ctx.fillStyle = "#333";
        ctx.fillRect(0, 0, canvas.width, canvas.height / 2);
        ctx.fillStyle = "#666";
        ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);

        // Cast rays
        const numRays = canvas.width;

        for (let i = 0; i < numRays; i++) {
          const rayAngle =
            player.angle - player.fov / 2 + (i / numRays) * player.fov;
          const { dist, wallType, side } = castRay(rayAngle);

          // Fix fisheye effect
          const correctedDist = dist * Math.cos(rayAngle - player.angle);
          const wallHeight = (canvas.height / correctedDist) * 0.6;

          drawWall(i, wallHeight, wallType, side);
        }
      }

      function update() {
        // Mouse rotation
        if (mouseX !== 0) {
          player.angle += mouseX * player.rotSpeed;
          mouseX = 0;
        }

        // Keyboard rotation
        if (keys["arrowleft"] || keys["q"]) player.angle -= player.rotSpeed * 5;
        if (keys["arrowright"] || keys["e"])
          player.angle += player.rotSpeed * 5;

        // Movement
        let moveX = 0,
          moveY = 0;

        if (keys["w"] || keys["arrowup"]) {
          moveX += Math.cos(player.angle) * player.speed;
          moveY += Math.sin(player.angle) * player.speed;
        }
        if (keys["s"] || keys["arrowdown"]) {
          moveX -= Math.cos(player.angle) * player.speed;
          moveY -= Math.sin(player.angle) * player.speed;
        }
        if (keys["a"]) {
          moveX += Math.cos(player.angle - Math.PI / 2) * player.speed;
          moveY += Math.sin(player.angle - Math.PI / 2) * player.speed;
        }
        if (keys["d"]) {
          moveX += Math.cos(player.angle + Math.PI / 2) * player.speed;
          moveY += Math.sin(player.angle + Math.PI / 2) * player.speed;
        }

        // Collision detection
        const newX = player.x + moveX;
        const newY = player.y + moveY;

        if (map[Math.floor(newY)][Math.floor(newX)] === 0) {
          player.x = newX;
          player.y = newY;
        }
      }

      function gameLoop() {
        update();
        render();
        requestAnimationFrame(gameLoop);
      }

      gameLoop();
    </script>
  </body>
</html>
